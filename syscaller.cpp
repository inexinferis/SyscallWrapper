#include "syscaller.h"

HMODULE hAplication=NULL;
HMODULE hNtDll=NULL;
HMODULE hKernel32=NULL;
DWORD iswow64=0;
DWORD wversion=WUNKNOWN;
DWORD syscallTable[93][WVERSIONS] = {
  /*  XP  ,  2003 , Vista ,   7   ,   8   ,  8.1  ,   10  , 10 TH2, 10 AU , 10 CU , 10 FCU */
  { 0x000b, 0x000c, 0x000c, 0x000c, 0x019E, 0x01A3, 0x01AB, 0x01AE, 0x01B0, 0x01B5, 0x01B9 }, /* 000 NtAdjustPrivilegesToken */
  { 0x0011, 0x0012, 0x0012, 0x0013, 0x0196, 0x019B, 0x01A3, 0x01A6, 0x01A8, 0x01AD, 0x01B1 }, /* 001 NtAllocateVirtualMemory */
  { 0x0018, 0x001a, 0x002e, 0x0031, 0x0175, 0x017A, 0x0181, 0x0184, 0x0186, 0x018B, 0x018E }, /* 002 NtClearEvent */
  { 0x0019, 0x001b, 0x002f, 0x0032, 0x0174, 0x0179, 0x0180, 0x0183, 0x0185, 0x018A, 0x018D }, /* 003 NtClose */
  { 0x0023, 0x0025, 0x0039, 0x0040, 0x0165, 0x016A, 0x0170, 0x0172, 0x0174, 0x0177, 0x017A }, /* 004 NtCreateEvent */
  { 0x0025, 0x0027, 0x003b, 0x0042, 0x0163, 0x0168, 0x016E, 0x0170, 0x0172, 0x0175, 0x0178 }, /* 005 NtCreateFile */
  { 0x0029, 0x002b, 0x003f, 0x0046, 0x015E, 0x0162, 0x0168, 0x016A, 0x016C, 0x016F, 0x0172 }, /* 006 NtCreateKey */
  { 0x002b, 0x002d, 0x0041, 0x004a, 0x015A, 0x015E, 0x0164, 0x0166, 0x0168, 0x016B, 0x016E }, /* 007 NtCreateMutant */
  { 0x002c, 0x002e, 0x0042, 0x004b, 0x0159, 0x015D, 0x0163, 0x0165, 0x0167, 0x016A, 0x016D }, /* 008 NtCreateNamedPipeFile */
  { 0x002f, 0x0031, 0x0046, 0x004f, 0x0155, 0x0159, 0x015F, 0x0161, 0x0163, 0x0166, 0x0169 }, /* 009 NtCreateProcess */
  { 0x0032, 0x0034, 0x0049, 0x0054, 0x0150, 0x0154, 0x015A, 0x015C, 0x015E, 0x0161, 0x0164 }, /* 010 NtCreateSection */
  { 0x0033, 0x0035, 0x004a, 0x0055, 0x014F, 0x0153, 0x0159, 0x015B, 0x015D, 0x0160, 0x0163 }, /* 011 NtCreateSemaphore */
  { 0x0035, 0x0037, 0x004c, 0x0057, 0x014D, 0x0151, 0x0157, 0x0159, 0x015B, 0x015E, 0x0161 }, /* 012 NtCreateThread */
  { 0x0000, 0x0000, 0x017e, 0x0058, 0x014C, 0x0150, 0x0156, 0x0158, 0x015A, 0x015D, 0x0160 }, /* 013 NtCreateThreadEx */
  { 0x003c, 0x003e, 0x0076, 0x0063, 0x013D, 0x0141, 0x0146, 0x0148, 0x014A, 0x014E, 0x0151 }, /* 014 NtDelayExecution */
  { 0x0040, 0x0043, 0x007c, 0x0068, 0x0138, 0x013C, 0x0141, 0x0143, 0x0145, 0x0149, 0x014C }, /* 015 NtDeleteKey */
  { 0x0043, 0x0046, 0x007f, 0x006d, 0x0131, 0x0135, 0x013A, 0x013C, 0x013E, 0x0143, 0x0146 }, /* 016 NtDeviceIoControlFile */
  { 0x0049, 0x004d, 0x0086, 0x0077, 0x0127, 0x012B, 0x0130, 0x0132, 0x0134, 0x013A, 0x013D }, /* 017 NtEnumerateKey */
  { 0x004f, 0x0053, 0x008c, 0x007e, 0x011D, 0x0121, 0x0126, 0x0128, 0x012A, 0x012E, 0x0131 }, /* 018 NtFlushInstructionCache */
  { 0x0054, 0x0058, 0x0094, 0x0086, 0x0115, 0x0119, 0x011E, 0x0120, 0x0122, 0x0128, 0x012B }, /* 019 NtFreeVirtualMemory */
  { 0x0055, 0x0059, 0x0095, 0x0087, 0x0113, 0x0116, 0x011B, 0x011D, 0x011F, 0x0125, 0x0128 }, /* 020 NtFsControlFile */
  { 0x0057, 0x005b, 0x0098, 0x008f, 0x0111, 0x010F, 0x0113, 0x0115, 0x0117, 0x0122, 0x0125 }, /* 021 NtGetContextThread */
  { 0x0061, 0x0065, 0x00a3, 0x009b, 0x0100, 0x0103, 0x0107, 0x0108, 0x010A, 0x010D, 0x0110 }, /* 022 NtLoadDriver */
  { 0x006c, 0x0071, 0x00af, 0x00a8, 0x00F3, 0x00F6, 0x00FA, 0x00FA, 0x00FC, 0x00FE, 0x0101 }, /* 023 NtMapViewOfSection */
  { 0x0071, 0x0077, 0x00b5, 0x00af, 0x00EC, 0x00EF, 0x00F2, 0x00F2, 0x00F4, 0x00F6, 0x00F8 }, /* 024 NtOpenDirectoryObject */
  { 0x0072, 0x0078, 0x00b6, 0x00b1, 0x00EA, 0x00ED, 0x00F0, 0x00F0, 0x00F2, 0x00F4, 0x00F6 }, /* 025 NtOpenEvent */
  { 0x0074, 0x007a, 0x00b8, 0x00b3, 0x00E8, 0x00EB, 0x00EE, 0x00EE, 0x00F0, 0x00F2, 0x00F4 }, /* 026 NtOpenFile */
  { 0x0077, 0x007d, 0x00bb, 0x00b6, 0x00E5, 0x00E8, 0x00EB, 0x00EB, 0x00ED, 0x00EF, 0x00F1 }, /* 027 NtOpenKey */
  { 0x0078, 0x007e, 0x00bc, 0x00bb, 0x00E0, 0x00E3, 0x00E6, 0x00E6, 0x00E8, 0x00EA, 0x00EC }, /* 028 NtOpenMutant */
  { 0x007a, 0x0080, 0x00bf, 0x00be, 0x00DD, 0x00E0, 0x00E3, 0x00E3, 0x00E5, 0x00E7, 0x00E9 }, /* 029 NtOpenProcess */
  { 0x007b, 0x0081, 0x00c0, 0x00bf, 0x00DC, 0x00DF, 0x00E2, 0x00E2, 0x00E4, 0x00E6, 0x00E8 }, /* 030 NtOpenProcessToken */
  { 0x007d, 0x0083, 0x00c2, 0x00c2, 0x00D9, 0x00DC, 0x00DE, 0x00DE, 0x00E0, 0x00E2, 0x00E4 }, /* 031 NtOpenSection */
  { 0x007e, 0x0084, 0x00c3, 0x00c3, 0x00D8, 0x00DB, 0x00DD, 0x00DD, 0x00DF, 0x00E1, 0x00E3 }, /* 032 NtOpenSemaphore */
  { 0x007f, 0x0085, 0x00c5, 0x00c5, 0x00D6, 0x00D9, 0x00DB, 0x00DB, 0x00DD, 0x00DF, 0x00E1 }, /* 033 NtOpenSymbolicLinkObject */
  { 0x0080, 0x0086, 0x00c6, 0x00c6, 0x00D5, 0x00D8, 0x00DA, 0x00DA, 0x00DC, 0x00DE, 0x00E0 }, /* 034 NtOpenThread */
  { 0x0081, 0x0087, 0x00c7, 0x00c7, 0x00D4, 0x00D7, 0x00D9, 0x00D9, 0x00DB, 0x00DD, 0x00DF }, /* 035 NtOpenThreadToken */
  { 0x0089, 0x008f, 0x00cf, 0x00d7, 0x00C3, 0x00C6, 0x00C8, 0x00C8, 0x00CA, 0x00CC, 0x00CE }, /* 036 NtProtectVirtualMemory */
  { 0x008a, 0x0090, 0x00d0, 0x00d8, 0x00C2, 0x00C5, 0x00C7, 0x00C7, 0x00C9, 0x00CB, 0x00CD }, /* 037 NtPulseEvent */
  { 0x008b, 0x0091, 0x00d1, 0x00d9, 0x00C1, 0x00C4, 0x00C6, 0x00C6, 0x00C8, 0x00CA, 0x00CC }, /* 038 NtQueryAttributesFile */
  { 0x0092, 0x0098, 0x00d8, 0x00e0, 0x00BA, 0x00BD, 0x00BF, 0x00BF, 0x00C1, 0x00C3, 0x00C4 }, /* 039 NtQueryDirectoryObject */
  { 0x0097, 0x009e, 0x00de, 0x00e7, 0x00B3, 0x00B6, 0x00B8, 0x00B8, 0x00BA, 0x00BB, 0x00BC }, /* 040 NtQueryInformationFile */
  { 0x009a, 0x00a1, 0x00e1, 0x00ea, 0x00B0, 0x00B3, 0x00B5, 0x00B5, 0x00B7, 0x00B8, 0x00B9 }, /* 041 NtQueryInformationProcess */
  { 0x009b, 0x00a2, 0x00e2, 0x00ec, 0x00AE, 0x00B1, 0x00B3, 0x00B3, 0x00B5, 0x00B6, 0x00B7 }, /* 042 NtQueryInformationThread */
  { 0x00a5, 0x00ad, 0x00ed, 0x00fb, 0x009F, 0x00A2, 0x00A4, 0x00A4, 0x00A6, 0x00A7, 0x00A8 }, /* 043 NtQueryPerformanceCounter */
  { 0x00aa, 0x00b2, 0x00f2, 0x0102, 0x0098, 0x009B, 0x009D, 0x009D, 0x009E, 0x009F, 0x00A0 }, /* 044 NtQuerySymbolicLinkObject */
  { 0x00ad, 0x00b5, 0x00f5, 0x0105, 0x0095, 0x0098, 0x009A, 0x009A, 0x009B, 0x009C, 0x009D }, /* 045 NtQuerySystemInformation */
  { 0x00b1, 0x00b9, 0x00f9, 0x010a, 0x0090, 0x0093, 0x0095, 0x0095, 0x0096, 0x0097, 0x0098 }, /* 046 NtQueryValueKey */
  { 0x00b2, 0x00ba, 0x00fa, 0x010b, 0x008F, 0x0092, 0x0094, 0x0094, 0x0095, 0x0096, 0x0097 }, /* 047 NtQueryVirtualMemory */
  { 0x00b6, 0x00be, 0x00fe, 0x0110, 0x0088, 0x008B, 0x008D, 0x008D, 0x008E, 0x008E, 0x008F }, /* 048 NtRaiseHardError */
  { 0x00b7, 0x00bf, 0x00ff, 0x0111, 0x0087, 0x008A, 0x008C, 0x008C, 0x008D, 0x008D, 0x008E }, /* 049 NtReadFile */
  { 0x00ba, 0x00c2, 0x0102, 0x0115, 0x0083, 0x0086, 0x0088, 0x0088, 0x0089, 0x0089, 0x008A }, /* 050 NtReadVirtualMemory */
  { 0x00bc, 0x00c4, 0x0104, 0x011c, 0x007C, 0x007F, 0x0081, 0x0081, 0x0082, 0x0082, 0x0083 }, /* 051 NtReleaseMutant */
  { 0x00bd, 0x00c5, 0x0105, 0x011d, 0x007B, 0x007E, 0x0080, 0x0080, 0x0081, 0x0081, 0x0082 }, /* 052 NtReleaseSemaphore */
  { 0x00ce, 0x00d6, 0x0116, 0x0130, 0x0068, 0x006B, 0x006D, 0x006D, 0x006E, 0x006E, 0x006F }, /* 053 NtResumeThread */
  { 0x00d5, 0x00dd, 0x0122, 0x013c, 0x005B, 0x005E, 0x005F, 0x005F, 0x005F, 0x005F, 0x0060 }, /* 054 NtSetContextThread */
  { 0x00db, 0x00e4, 0x0129, 0x0143, 0x0054, 0x0057, 0x0058, 0x0058, 0x0058, 0x0058, 0x0059 }, /* 055 NtSetEvent */
  { 0x00e0, 0x00e9, 0x012e, 0x0149, 0x004E, 0x0051, 0x0052, 0x0052, 0x0052, 0x0052, 0x0053 }, /* 056 NtSetInformationFile */
  { 0x00e4, 0x00ed, 0x0132, 0x014d, 0x004A, 0x004D, 0x004E, 0x004E, 0x004E, 0x004E, 0x004F }, /* 057 NtSetInformationProcess */
  { 0x00e5, 0x00ee, 0x0133, 0x014f, 0x0048, 0x004B, 0x004C, 0x004C, 0x004C, 0x004C, 0x004D }, /* 058 NtSetInformationThread */
  { 0x00f7, 0x0100, 0x0145, 0x0166, 0x0030, 0x0031, 0x0032, 0x0032, 0x0032, 0x0032, 0x0033 }, /* 059 NtSetValueKey */
  { 0x00fe, 0x0107, 0x014c, 0x016f, 0x0026, 0x0026, 0x0027, 0x0027, 0x0027, 0x0027, 0x0028 }, /* 060 NtSuspendThread */
  { 0x0101, 0x010a, 0x014f, 0x0172, 0x0023, 0x0023, 0x0024, 0x0024, 0x0024, 0x0024, 0x0024 }, /* 061 NtTerminateProcess */
  { 0x0102, 0x010b, 0x0150, 0x0173, 0x0022, 0x0022, 0x0023, 0x0023, 0x0023, 0x0023, 0x0023 }, /* 062 NtTerminateThread */
  { 0x0106, 0x010f, 0x0157, 0x017b, 0x001A, 0x001A, 0x001B, 0x001B, 0x001B, 0x001B, 0x001B }, /* 063 NtUnloadDriver */
  { 0x010b, 0x0115, 0x015d, 0x0181, 0x0013, 0x0013, 0x0014, 0x0014, 0x0014, 0x0014, 0x0014 }, /* 064 NtUnmapViewOfSection */
  { 0x010e, 0x0118, 0x0160, 0x0185, 0x000C, 0x000C, 0x000D, 0x000D, 0x000D, 0x000D, 0x000D }, /* 065 NtWaitForMultipleObjects */
  { 0x010f, 0x0119, 0x0161, 0x0187, 0x000A, 0x000A, 0x000B, 0x000B, 0x000B, 0x000B, 0x000B }, /* 066 NtWaitForSingleObject */
  { 0x0112, 0x011c, 0x0164, 0x018c, 0x0005, 0x0006, 0x0007, 0x0007, 0x0007, 0x0007, 0x0007 }, /* 067 NtWriteFile */
  { 0x0115, 0x011f, 0x0167, 0x018f, 0x0002, 0x0003, 0x0004, 0x0004, 0x0004, 0x0004, 0x0004 }, /* 068 NtWriteVirtualMemory */
  //win32k
  { 0x100d, 0x100d, 0x100d, 0x100e, 0x112E, 0x1130, 0x1131, 0x1133, 0x1134, 0x10F1, 0x10F2 }, /* 069 NtGdiBitBlt */
  { 0x101d, 0x101d, 0x101e, 0x101f, 0x111C, 0x111E, 0x111F, 0x1121, 0x1122, 0x10DF, 0x10E0 }, /* 070 NtGdiCreateCompatibleBitmap */
  { 0x101e, 0x101e, 0x101f, 0x1020, 0x111B, 0x111D, 0x111E, 0x1120, 0x1121, 0x10DE, 0x10DF }, /* 071 NtGdiCreateCompatibleDC */
  { 0x107a, 0x107a, 0x107c, 0x107d, 0x10BD, 0x10BF, 0x10C0, 0x10C2, 0x10C2, 0x10C9, 0x10CA }, /* 072 NtGdiDeleteObjectApp */
  { 0x1091, 0x1091, 0x1094, 0x1094, 0x10A6, 0x10A8, 0x10A9, 0x10AB, 0x10AB, 0x10B2, 0x10B3 }, /* 073 NtGdiExtSelectClipRgn */
  { 0x10ae, 0x10ad, 0x10b3, 0x10b3, 0x1087, 0x1088, 0x1089, 0x1089, 0x1089, 0x1090, 0x1091 }, /* 074 NtGdiGetDIBitsInternal */
  { 0x10ea, 0x10e9, 0x10f2, 0x10f4, 0x1046, 0x1047, 0x1048, 0x1048, 0x1048, 0x104F, 0x1050 }, /* 075 NtGdiPatBlt */
  { 0x1102, 0x1101, 0x110a, 0x110c, 0x102E, 0x102F, 0x1030, 0x1030, 0x1030, 0x1037, 0x1038 }, /* 076 NtGdiSelectBrush */
  { 0x1104, 0x1103, 0x110c, 0x110e, 0x102C, 0x102D, 0x102E, 0x102E, 0x102E, 0x1035, 0x1036 }, /* 077 NtGdiSelectFont */
  { 0x1105, 0x1104, 0x110d, 0x110f, 0x102B, 0x102C, 0x102D, 0x102D, 0x102D, 0x1034, 0x1035 }, /* 078 NtGdiSelectPen */
  {	0x110f, 0x110e, 0x1117, 0x1119, 0x1021, 0x1022, 0x1023, 0x1023, 0x1023, 0x1027, 0x1028 }, /* 079 NtGdiSetDIBitsToDeviceInternal */
  { 0x1138, 0x1137, 0x1142, 0x1143, 0x1168, 0x116A, 0x116B, 0x116D, 0x116F, 0x112D, 0x112E }, /* 080 NtUserBuildHwndList */
  { 0x1143, 0x1142, 0x114d, 0x114e, 0x115D, 0x115F, 0x1160, 0x1162, 0x1163, 0x1121, 0x1122 }, /* 081 NtUserCallOneParam */
  { 0x117a, 0x1179, 0x1187, 0x118c, 0x11CB, 0x11CC, 0x11CE, 0x11D0, 0x11D2, 0x1190, 0x1193 }, /* 082 NtUserFindWindowEx */
  { 0x117f, 0x117e, 0x118d, 0x1192, 0x11C5, 0x11C6, 0x11C8, 0x11CA, 0x11CC, 0x118A, 0x118D }, /* 083 NtUserGetAsyncKeyState */
  { 0x1191, 0x1190, 0x119f, 0x11a4, 0x11B1, 0x11B2, 0x11B4, 0x11B6, 0x11B8, 0x1176, 0x1179 }, /* 084 NtUserGetDC */
  { 0x1196, 0x1195, 0x11a4, 0x11a9, 0x11AA, 0x11AC, 0x11AD, 0x11AF, 0x11B2, 0x1170, 0x1173 }, /* 085 NtUserGetGUIThreadInfo */
  { 0x11b7, 0x11b6, 0x11c6, 0x11cf, 0x1183, 0x1185, 0x1186, 0x1188, 0x118A, 0x1148, 0x1149 }, /* 086 NtUserGetWindowDC */
  { 0x11b8, 0x11b7, 0x11c7, 0x11d1, 0x1181, 0x1183, 0x1184, 0x1186, 0x1188, 0x1146, 0x1147 }, /* 087 NtUserGetWindowPlacement */
  { 0x11db, 0x11da, 0x11f1, 0x11fc, 0x11EA, 0x11EC, 0x11EE, 0x11F0, 0x11F3, 0x11B1, 0x11B4 }, /* 088 NtUserPostMessage */
  { 0x11e3, 0x11e1, 0x11f8, 0x1203, 0x11E2, 0x11E3, 0x11E5, 0x11E7, 0x11EA, 0x11A8, 0x11AB }, /* 089 NtUserQueryWindow */
  { 0x1248, 0x1244, 0x1260, 0x126d, 0x1291, 0x1294, 0x129E, 0x129F, 0x12A5, 0x1266, 0x126F }, /* 090 NtUserValidateHandleSecure */
  { 0x11cc, 0x11cb, 0x11df, 0x11ea, 0x11FC, 0x11FE, 0x1200, 0x1202, 0x1205, 0x11C3, 0x11C6 }, /* 091 NtUserMessageCall */
  { 0x1101, 0x1100, 0x1109, 0x110b, 0x102F, 0x1030, 0x1031, 0x1031, 0x1031, 0x1038, 0x1039 }, /* 092 NtGdiSelectBitmap */
};

DWORD wowsyscallTable[93][WVERSIONS] = {
  /*  XP  ,  2003 , Vista ,   7   ,   8   ,  8.1  ,   10  , 10 TH2, 10 AU , 10 CU , 10 FCU */
  { 0x003E, 0x003E, 0x003E, 0x003E, 0x003F, 0x0040, 0x0041, 0x0041, 0x0041, 0x0041, 0x0041 }, /* 000 NtAdjustPrivilegesToken */
  { 0x0015, 0x0015, 0x0015, 0x0015, 0x0016, 0x0017, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018 }, /* 001 NtAllocateVirtualMemory */
  { 0x003B, 0x003B, 0x003B, 0x003B, 0x003C, 0x003D, 0x003E, 0x003E, 0x003E, 0x003E, 0x003E }, /* 002 NtClearEvent */
  { 0x000C, 0x000C, 0x000C, 0x000C, 0x000D, 0x000E, 0x000F, 0x000F, 0x000F, 0x000F, 0x000F }, /* 003 NtClose */
  { 0x0045, 0x0045, 0x0045, 0x0045, 0x0046, 0x0047, 0x0048, 0x0048, 0x0048, 0x0048, 0x0048 }, /* 004 NtCreateEvent */
  { 0x0052, 0x0052, 0x0052, 0x0052, 0x0053, 0x0054, 0x0055, 0x0055, 0x0055, 0x0055, 0x0055 }, /* 005 NtCreateFile */
  { 0x001A, 0x001A, 0x001A, 0x001A, 0x001B, 0x001C, 0x001D, 0x001D, 0x001D, 0x001D, 0x001D }, /* 006 NtCreateKey */
  { 0x007E, 0x007E, 0x009B, 0x009A, 0x00A4, 0x00A5, 0x00A7, 0x00A8, 0x00A9, 0x00AC, 0x00AD }, /* 007 NtCreateMutant */
  { 0x007F, 0x007F, 0x009C, 0x009B, 0x00A5, 0x00A6, 0x00A8, 0x00A9, 0x00AA, 0x00AD, 0x00AE }, /* 008 NtCreateNamedPipeFile */
  { 0x0082, 0x0082, 0x00A0, 0x009F, 0x00A9, 0x00AA, 0x00AD, 0x00AE, 0x00AF, 0x00B2, 0x00B3 }, /* 009 NtCreateProcess */
  { 0x0047, 0x0047, 0x0047, 0x0047, 0x0048, 0x0049, 0x004A, 0x004A, 0x004A, 0x004A, 0x004A }, /* 010 NtCreateSection */
  { 0x0084, 0x0084, 0x00A3, 0x00A3, 0x00AD, 0x00AE, 0x00B1, 0x00B2, 0x00B4, 0x00B7, 0x00B8 }, /* 011 NtCreateSemaphore */
  { 0x004B, 0x004B, 0x004B, 0x004B, 0x004C, 0x004D, 0x004E, 0x004E, 0x004E, 0x004E, 0x004E }, /* 012 NtCreateThread */
  { 0x0000, 0x0000, 0x00A5, 0x00A5, 0x00AF, 0x00B0, 0x00B3, 0x00B4, 0x00B6, 0x00B9, 0x00BA }, /* 013 NtCreateThreadEx */
  { 0x008B, 0x008B, 0x00AF, 0x00AF, 0x00BC, 0x00BE, 0x00C1, 0x00C2, 0x00C4, 0x0034, 0x0034 }, /* 014 NtDelayExecution */
  { 0x0090, 0x0090, 0x00B4, 0x00B4, 0x00C1, 0x00C3, 0x00C6, 0x00C7, 0x00C9, 0x00CB, 0x00CC }, /* 015 NtDeleteKey */
  { 0x0092, 0x0092, 0x00B7, 0x00B8, 0x00C7, 0x00C9, 0x00CC, 0x00CD, 0x00CF, 0x0007, 0x0007 }, /* 016 NtDeviceIoControlFile */
  { 0x0010, 0x0010, 0x0010, 0x0010, 0x0011, 0x0012, 0x0013, 0x0013, 0x0013, 0x0032, 0x0032 }, /* 017 NtEnumerateKey */
  { 0x0099, 0x0099, 0x00C0, 0x00C3, 0x00D5, 0x00D7, 0x00DA, 0x00DB, 0x00DD, 0x00DF, 0x00E0 }, /* 018 NtFlushInstructionCache */
  { 0x0036, 0x0036, 0x0036, 0x0036, 0x0037, 0x0038, 0x0039, 0x0039, 0x0039, 0x001E, 0x001E }, /* 019 NtFreeVirtualMemory */
  { 0x009D, 0x009D, 0x00C7, 0x00CA, 0x00DD, 0x00E0, 0x00E3, 0x00E4, 0x00E6, 0x0039, 0x0039 }, /* 020 NtFsControlFile */
  { 0x00A0, 0x00A0, 0x00CF, 0x00D2, 0x00E4, 0x00E7, 0x00EB, 0x00EC, 0x00EE, 0x00E9, 0x00EA }, /* 021 NtGetContextThread */
  { 0x00A8, 0x00A8, 0x00D9, 0x00DC, 0x00EE, 0x00F1, 0x00F5, 0x00F7, 0x00F9, 0x00FC, 0x00FD }, /* 022 NtLoadDriver */
  { 0x0025, 0x0025, 0x0025, 0x0025, 0x0026, 0x0027, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028 }, /* 023 NtMapViewOfSection */
  { 0x0055, 0x0055, 0x0055, 0x0055, 0x0056, 0x0057, 0x0058, 0x0058, 0x0058, 0x0058, 0x0058 }, /* 024 NtOpenDirectoryObject */
  { 0x003D, 0x003D, 0x003D, 0x003D, 0x003E, 0x003F, 0x0040, 0x0040, 0x0040, 0x0040, 0x0040 }, /* 025 NtOpenEvent */
  { 0x0030, 0x0030, 0x0030, 0x0030, 0x0031, 0x0032, 0x0033, 0x0033, 0x0033, 0x0033, 0x0033 }, /* 026 NtOpenFile */
  { 0x000F, 0x000F, 0x000F, 0x000F, 0x0010, 0x0011, 0x0012, 0x0012, 0x0012, 0x0012, 0x0012 }, /* 027 NtOpenKey */
  { 0x00BC, 0x00BC, 0x00F0, 0x00F6, 0x0108, 0x010B, 0x0110, 0x0113, 0x0115, 0x0119, 0x011B }, /* 028 NtOpenMutant */
  { 0x0023, 0x0023, 0x0023, 0x0023, 0x0024, 0x0025, 0x0026, 0x0026, 0x0026, 0x0026, 0x0026 }, /* 029 NtOpenProcess */
  { 0x00BE, 0x00BE, 0x00F3, 0x00F9, 0x010B, 0x010E, 0x0114, 0x0117, 0x0119, 0x011D, 0x011F }, /* 030 NtOpenProcessToken */
  { 0x0034, 0x0034, 0x0034, 0x0034, 0x0035, 0x0036, 0x0037, 0x0037, 0x0037, 0x0037, 0x0037 }, /* 031 NtOpenSection */
  { 0x00BF, 0x00BF, 0x00F5, 0x00FB, 0x010D, 0x0110, 0x0116, 0x0119, 0x011C, 0x0120, 0x0122 }, /* 032 NtOpenSemaphore */
  { 0x00C0, 0x00C0, 0x00F7, 0x00FD, 0x010F, 0x0112, 0x0118, 0x011B, 0x011E, 0x0122, 0x0124 }, /* 033 NtOpenSymbolicLinkObject */
  { 0x00C1, 0x00C1, 0x00F8, 0x00FE, 0x0110, 0x0113, 0x0119, 0x011C, 0x011F, 0x0123, 0x0125 }, /* 034 NtOpenThread */
  { 0x0021, 0x0021, 0x0021, 0x0021, 0x0022, 0x0023, 0x0024, 0x0024, 0x0024, 0x0024, 0x0024 }, /* 035 NtOpenThreadToken */
  { 0x004D, 0x004D, 0x004D, 0x004D, 0x004E, 0x004F, 0x0050, 0x0050, 0x0050, 0x0050, 0x0050 }, /* 036 NtProtectVirtualMemory */
  { 0x00C7, 0x00C7, 0x0106, 0x010C, 0x011E, 0x0121, 0x0127, 0x012A, 0x012D, 0x0131, 0x0133 }, /* 037 NtPulseEvent */
  { 0x003A, 0x003A, 0x003A, 0x003A, 0x003B, 0x003C, 0x003D, 0x003D, 0x003D, 0x003D, 0x003D }, /* 038 NtQueryAttributesFile */
  { 0x00CB, 0x00CB, 0x010A, 0x0110, 0x0122, 0x0125, 0x012B, 0x012E, 0x0131, 0x0136, 0x0139 }, /* 039 NtQueryDirectoryObject */
  { 0x000E, 0x000E, 0x000E, 0x000E, 0x000F, 0x0010, 0x0011, 0x0011, 0x0011, 0x0011, 0x0011 }, /* 040 NtQueryInformationFile */
  { 0x0016, 0x0016, 0x0016, 0x0016, 0x0017, 0x0018, 0x0019, 0x0019, 0x0019, 0x0019, 0x0019 }, /* 041 NtQueryInformationProcess */
  { 0x0022, 0x0022, 0x0022, 0x0022, 0x0023, 0x0024, 0x0025, 0x0025, 0x0025, 0x0025, 0x0025 }, /* 042 NtQueryInformationThread */
  { 0x002E, 0x002E, 0x002E, 0x002E, 0x002F, 0x0030, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031 }, /* 043 NtQueryPerformanceCounter */
  { 0x00DD, 0x00DD, 0x0122, 0x0129, 0x013B, 0x013E, 0x0144, 0x0147, 0x014B, 0x0151, 0x0154 }, /* 044 NtQuerySymbolicLinkObject */
  { 0x0033, 0x0033, 0x0033, 0x0033, 0x0034, 0x0035, 0x0036, 0x0036, 0x0036, 0x0036, 0x0036 }, /* 045 NtQuerySystemInformation */
  { 0x0014, 0x0014, 0x0014, 0x0014, 0x0015, 0x0016, 0x0017, 0x0017, 0x0017, 0x0017, 0x0017 }, /* 046 NtQueryValueKey */
  { 0x0020, 0x0020, 0x0020, 0x0020, 0x0021, 0x0022, 0x0023, 0x0023, 0x0023, 0x0023, 0x0023 }, /* 047 NtQueryVirtualMemory */
  { 0x00E2, 0x00E2, 0x0127, 0x0130, 0x0144, 0x0147, 0x014D, 0x0150, 0x0154, 0x015A, 0x015D }, /* 048 NtRaiseHardError */
  { 0x0003, 0x0003, 0x0003, 0x0003, 0x0004, 0x0005, 0x0006, 0x0006, 0x0006, 0x0006, 0x0006 }, /* 049 NtReadFile */
  { 0x003C, 0x003C, 0x003C, 0x003C, 0x003D, 0x003E, 0x003F, 0x003F, 0x003F, 0x003F, 0x003F }, /* 050 NtReadVirtualMemory */
  { 0x001D, 0x001D, 0x001D, 0x001D, 0x001E, 0x001F, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020 }, /* 051 NtReleaseMutant */
  { 0x0007, 0x0007, 0x0007, 0x0007, 0x0008, 0x0009, 0x000A, 0x000A, 0x000A, 0x000A, 0x000A }, /* 052 NtReleaseSemaphore */
  { 0x004F, 0x004F, 0x004F, 0x004F, 0x0050, 0x0051, 0x0052, 0x0052, 0x0052, 0x0052, 0x0052 }, /* 053 NtResumeThread */
  { 0x00F6, 0x00F6, 0x0149, 0x0150, 0x0165, 0x0168, 0x016F, 0x0172, 0x0178, 0x017E, 0x0181 }, /* 054 NtSetContextThread */
  { 0x000B, 0x000B, 0x000B, 0x000B, 0x000C, 0x000D, 0x000E, 0x000E, 0x000E, 0x000E, 0x000E }, /* 055 NtSetEvent */
  { 0x0024, 0x0024, 0x0024, 0x0024, 0x0025, 0x0026, 0x0027, 0x0027, 0x0027, 0x0027, 0x0027 }, /* 056 NtSetInformationFile */
  { 0x0019, 0x0019, 0x0019, 0x0019, 0x001A, 0x001B, 0x001C, 0x001C, 0x001C, 0x001C, 0x001C }, /* 057 NtSetInformationProcess */
  { 0x000A, 0x000A, 0x000A, 0x000A, 0x000B, 0x000C, 0x000D, 0x000D, 0x000D, 0x000D, 0x000D }, /* 058 NtSetInformationThread */
  { 0x005D, 0x005D, 0x005D, 0x005D, 0x005E, 0x005F, 0x0060, 0x0060, 0x0060, 0x0060, 0x0060 }, /* 059 NtSetValueKey */
  { 0x0118, 0x0118, 0x0172, 0x017B, 0x0193, 0x0198, 0x01A0, 0x01A3, 0x01A9, 0x01AF, 0x01B2 }, /* 060 NtSuspendThread */
  { 0x0029, 0x0029, 0x0029, 0x0029, 0x002A, 0x002B, 0x002C, 0x002C, 0x002C, 0x002C, 0x002C }, /* 061 NtTerminateProcess */
  { 0x0050, 0x0050, 0x0050, 0x0050, 0x0051, 0x0052, 0x0053, 0x0053, 0x0053, 0x0053, 0x0053 }, /* 062 NtTerminateThread */
  { 0x011D, 0x011D, 0x017A, 0x0184, 0x019C, 0x01A1, 0x01A9, 0x01AC, 0x01B2, 0x01B8, 0x01BC }, /* 063 NtUnloadDriver */
  { 0x0027, 0x0027, 0x0027, 0x0027, 0x0028, 0x0029, 0x002A, 0x002A, 0x002A, 0x002A, 0x002A }, /* 064 NtUnmapViewOfSection */
  { 0x0058, 0x0058, 0x0058, 0x0058, 0x0059, 0x005A, 0x005B, 0x005B, 0x005B, 0x005B, 0x005B }, /* 065 NtWaitForMultipleObjects */
  { 0x0001, 0x0001, 0x0001, 0x0001, 0x0002, 0x0003, 0x0004, 0x0004, 0x0004, 0x0004, 0x0004 }, /* 066 NtWaitForSingleObject */
  { 0x0005, 0x0005, 0x0005, 0x0005, 0x0006, 0x0007, 0x0008, 0x0008, 0x0008, 0x0008, 0x0008 }, /* 067 NtWriteFile */
  { 0x0037, 0x0037, 0x0037, 0x0037, 0x0038, 0x0039, 0x003A, 0x003A, 0x003A, 0x003A, 0x003A }, /* 068 NtWriteVirtualMemory */
  //win32k
  { 0x1008, 0x1008, 0x1008, 0x1008, 0x1009, 0x100A, 0x100B, 0x100B, 0x100B, 0x100B, 0x100B }, /* 069 NtGdiBitBlt */
  { 0x104A, 0x104A, 0x104B, 0x104B, 0x104C, 0x104D, 0x104E, 0x104E, 0x104E, 0x104E, 0x104E }, /* 070 NtGdiCreateCompatibleBitmap */
  { 0x1054, 0x1054, 0x1055, 0x1055, 0x1055, 0x1056, 0x1057, 0x1057, 0x1057, 0x1057, 0x1057 }, /* 071 NtGdiCreateCompatibleDC */
  { 0x1022, 0x1022, 0x1023, 0x1023, 0x1024, 0x1025, 0x1026, 0x1026, 0x1026, 0x1026, 0x1026 }, /* 072 NtGdiDeleteObjectApp */
  { 0x102D, 0x102D, 0x102E, 0x102E, 0x102F, 0x1030, 0x1031, 0x1031, 0x1031, 0x1031, 0x1031 }, /* 073 NtGdiExtSelectClipRgn */
  { 0x1086, 0x1086, 0x1087, 0x1085, 0x1085, 0x1086, 0x1087, 0x1087, 0x1087, 0x1085, 0x1085 }, /* 074 NtGdiGetDIBitsInternal */
  { 0x1059, 0x1059, 0x105A, 0x105A, 0x105A, 0x105B, 0x105C, 0x105C, 0x105C, 0x105C, 0x105C }, /* 075 NtGdiPatBlt */
  { 0x1202, 0x1202, 0x1250, 0x125C, 0x12A9, 0x12C2, 0x12FB, 0x12FF, 0x12F6, 0x12C6, 0x12E0 }, /* 076 NtGdiSelectBrush */
  { 0x1038, 0x1038, 0x1039, 0x1039, 0x103A, 0x103B, 0x103C, 0x103C, 0x103C, 0x103C, 0x103C }, /* 077 NtGdiSelectFont */
  { 0x1204, 0x1204, 0x1252, 0x125E, 0x12AB, 0x12C4, 0x12FD, 0x1301, 0x12F8, 0x12C8, 0x12E2 }, /* 078 NtGdiSelectPen */
  {	0x1028, 0x1028, 0x1029, 0x1029, 0x102A, 0x102B, 0x102C, 0x102C, 0x102C, 0x102C, 0x102C }, /* 079 NtGdiSetDIBitsToDeviceInternal */
  { 0x101B, 0x101B, 0x101C, 0x101C, 0x101D, 0x101E, 0x101F, 0x101F, 0x101F, 0x101F, 0x101F }, /* 080 NtUserBuildHwndList */
  { 0x1002, 0x1002, 0x1002, 0x1002, 0x1003, 0x1004, 0x1005, 0x1005, 0x1005, 0x1005, 0x1005 }, /* 081 NtUserCallOneParam */
  { 0x106E, 0x106E, 0x106F, 0x106E, 0x106E, 0x106F, 0x1070, 0x1070, 0x1070, 0x106F, 0x106F }, /* 082 NtUserFindWindowEx */
  { 0x1043, 0x1043, 0x1044, 0x1044, 0x1045, 0x1046, 0x1047, 0x1047, 0x1047, 0x1047, 0x1047 }, /* 083 NtUserGetAsyncKeyState */
  { 0x100A, 0x100A, 0x100A, 0x100A, 0x100B, 0x100C, 0x100D, 0x100D, 0x100D, 0x100D, 0x100D }, /* 084 NtUserGetDC */
  { 0x1104, 0x1104, 0x1105, 0x10FF, 0x10FF, 0x1100, 0x1101, 0x1101, 0x1100, 0x10F5, 0x10F5 }, /* 085 NtUserGetGUIThreadInfo */
  { 0x1063, 0x1063, 0x1064, 0x1064, 0x1064, 0x1065, 0x1066, 0x1066, 0x1066, 0x1066, 0x1066 }, /* 086 NtUserGetWindowDC */
  { 0x10D9, 0x10D9, 0x10DA, 0x10D5, 0x10D5, 0x10D6, 0x10D7, 0x10D7, 0x10D6, 0x10CB, 0x10CB }, /* 087 NtUserGetWindowPlacement */
  { 0x100E, 0x100E, 0x100F, 0x100F, 0x1010, 0x1011, 0x1012, 0x1012, 0x1012, 0x1012, 0x1012 }, /* 088 NtUserPostMessage */
  { 0x100F, 0x100F, 0x1010, 0x1010, 0x1011, 0x1012, 0x1013, 0x1013, 0x1013, 0x1013, 0x1013 }, /* 089 NtUserQueryWindow */
  { 0x1294, 0x1294, 0x12FE, 0x1334, 0x13D1, 0x1405, 0x1460, 0x1465, 0x1468, 0x1464, 0x148C }, /* 090 NtUserValidateHandleSecure */
  { 0x1007, 0x1007, 0x1007, 0x1007, 0x1008, 0x1009, 0x100A, 0x100A, 0x100A, 0x100A, 0x100A }, /* 091 NtUserMessageCall */
  { 0x100B, 0x100B, 0x100B, 0x100B, 0x100C, 0x100D, 0x100E, 0x100E, 0x100E, 0x100E, 0x100E }, /* 092 NtGdiSelectBitmap */
};

extern "C"{

  VOID GetCPUId(PDWORD dwStandard,PDWORD dwFeature){
    asm volatile ( "cpuid" : "=a"(*dwStandard), "=d"(*dwFeature) : "0"(1) : "ebx", "ecx" );
  }

  NTSTATUS KiFastSystemCallINT();
  asm(
    ".text;\r\n"
    ".globl _KiFastSystemCallINT\r\n"
    "_KiFastSystemCallINT:\r\n"
    " lea 0x8(%esp),%edx;\r\n"
    " int $0x2E;\r\n"
    " ret"
  );

  NTSTATUS KiFastSystemCallSE();
  asm(
    ".text;\r\n"
    ".globl _KiFastSystemCallSE\r\n"
    "_KiFastSystemCallSE:\r\n"
    " lea 0x8(%esp),%ecx;\r\n"
    " mov %esp,%edx;\r\n"
    " sysenter;\r\n"
    " ret"
  );

  //Windows 7 no reacomoda el stack :S
  //así que hay que hacer un movimiento loco de la pila :S
  NTSTATUS KiFastSystemCallWow7();
  asm(
    ".text;\r\n"
    ".globl _KiFastSystemCallWow7\r\n"
    "_KiFastSystemCallWow7:\r\n"
    " xor %ecx,%ecx;\r\n"
    " lea 0x8(%esp),%edx;\r\n"
    " add $0x4,%esp;\r\n"
    " call *%fs:(0xC0);\r\n"
    " add $0x4,%esp;\r\n"
    " push %eax;\r\n"
    " push %eax;\r\n"
    " mov 0x8(%esp),%eax;\r\n"
    " mov %eax,0x4(%esp);\r\n"
    " pop %eax;\r\n"
    " ret"
  );

  //Windows 8 no usa edx como puntero al stack :S
  //así que hay que hacer un movimiento loco de la pila :S
  NTSTATUS KiFastSystemCallWow();
  asm(
    ".text;\r\n"
    ".globl _KiFastSystemCallWow\r\n"
    "_KiFastSystemCallWow:\r\n"
    " xor %ecx,%ecx;\r\n"
    " lea 0x8(%esp),%edx;\r\n"
    " add $0x4,%esp;\r\n"
    " call *%fs:(0xC0);\r\n"
    " push %eax;\r\n"
    " push %eax;\r\n"
    " mov 0x8(%esp),%eax;\r\n"
    " mov %eax,0x4(%esp);\r\n"
    " pop %eax;\r\n"
    " ret"
  );

  DWORD WINAPI GetFuncOffset(DWORD index){
    if(iswow64)
      return wowsyscallTable[index][wversion];
    return syscallTable[index][wversion];
  }

  PVOID KiFastSystemCall=(PVOID)KiFastSystemCallINT;
  NTSTATUS FastSystemCall(DWORD _offset,...);
  asm(
    ".text;\r\n"
    ".globl _FastSystemCall\r\n"
    "_FastSystemCall:\r\n"
    " push 0x4(%esp);\r\n"
    " mov 0x4(%esp),%eax;\r\n"
    " mov %eax,0x8(%esp);\r\n"
    " call _GetFuncOffset;\r\n"
    " jmp *_KiFastSystemCall;\r\n"
  );

}

BOOL SetServices(){
  DWORD_PTR winMajor,winMinor,winBuild;
  DWORD dwStandard=0,dwFeature=0;
  if(wversion!=WUNKNOWN)
    return FALSE;
  //initialize some data
  PTEB teb=NtCurrentTeb();
  PPEB_LDR_DATA ldrData=teb->ProcessEnvironmentBlock->Ldr;
  if(ldrData){
    PLDR_DATA_TABLE_ENTRY pDTEntry=(PLDR_DATA_TABLE_ENTRY)&ldrData->InLoadOrderModuleList.Flink;
    if(pDTEntry){
      pDTEntry=(PLDR_DATA_TABLE_ENTRY)pDTEntry->InLoadOrderLinks.Flink;
      hAplication=(HMODULE)pDTEntry->DllBase;
      pDTEntry=(PLDR_DATA_TABLE_ENTRY)pDTEntry->InLoadOrderLinks.Flink;
      hNtDll=(HMODULE)pDTEntry->DllBase;
      pDTEntry=(PLDR_DATA_TABLE_ENTRY)pDTEntry->InLoadOrderLinks.Flink;
      hKernel32=(HMODULE)pDTEntry->DllBase;
    }
  }
  //Initialize Services
  PPEB peb=NtCurrentPeb();
  winMajor=peb->OSMajorVersion;
  winMinor=peb->OSMinorVersion;
  winBuild=peb->OSBuildNumber;
  iswow64=IsWow64();
  switch(winMajor){
    case 10:
      if(winMinor==0){
        switch(winBuild){
          case 10240:
            wversion=WIN10;
          break;
          case 10586:
            wversion=WIN10TH2;
          break;
          case 14393:
            wversion=WIN10AU;
          break;
          case 15063:
            wversion=WIN10CU;
          break;
          case 16299:
            wversion=WIN10FCU;
          break;
          default:break;
        }
      }
    break;
    case 6:
      switch(winMinor){
        case 0:
          wversion=WINVISTA;
        break;
        case 1:
          wversion=WIN7;
        break;
        case 2:
          wversion=WIN8;
        break;
        case 3:
          wversion=WIN81;
        break;
        default:break;
      }
    break;
    case 5:
      switch(winMinor){
        case 1:
          wversion=WINXP;
        break;
        case 2:
          wversion=WIN2K3;
        break;
        default:break;
      }
    break;
    default:break;
  }
  if(iswow64){
    if(wversion==WIN7)
      KiFastSystemCall=(PVOID)KiFastSystemCallWow7;
    else
      KiFastSystemCall=(PVOID)KiFastSystemCallWow;
  }else{
    GetCPUId(&dwStandard,&dwFeature);
    if(dwFeature&(1<<11))
      KiFastSystemCall=(PVOID)KiFastSystemCallSE;
  }
  return (wversion!=WUNKNOWN);
}
